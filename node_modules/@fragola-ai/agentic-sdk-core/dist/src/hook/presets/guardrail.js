import{FragolaError as d}from"@src/exceptions";const u=Symbol("Guardrail_fail"),m={message:"",[u]:!0},c=o=>({...m,message:o});class n extends d{constructor(t,i){super(t),this.cause=i,this.name="GuardrailConstrain",Error.captureStackTrace&&Error.captureStackTrace(this,n)}}const f=(o,t="keepAndAnnotate")=>i=>{i.onUserMessage(async(a,r)=>{const p=r.state.conversation.at(-1);p?.role=="user"&&p.meta?.guardrail.rejected&&await r.raw.updateConversation(e=>e.slice(0,-1),"remove:userMessage");for(const s of o){const e=await s(c,a,r);if(e&&typeof e=="object"&&"message"in e&&e[u]){if(await r.stop(),t=="keepAndAnnotate"){const l={guardrail:{rejected:!0,guard:s.name,reason:e.message}};a.meta?a.meta={...a.meta,...l}:a.meta=l,r.raw.appendMessages([a],!1,"userMessage")}else t=="remove";throw new n(e.message,s.name)}}return a})};export{n as GuardrailConstrain,c as fail,f as guardrail};
//# sourceMappingURL=guardrail.js.map
